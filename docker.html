---
layout: default
---
<div id="content">

<h2 class="title">B-Translator With Docker</h2>

<p>Installing a B-Translator Server or Client in a Docker container has
some advantages, compared to installing it in a chroot environment.
For example:
</p><ul>
<li>
More platform independent (can be installed even on
<i>Mac-OS-X</i> or <i>Windows</i>).
</li>
<li>
Better isolation of the guest system from the host system.
</li>
<li>
Can easily run multiple instances of the server or client on the
same host (useful for development, testing, or resource
concentration), etc.

</li>
</ul>

<p>However you have to be familiar with the Docker concepts and tools,
and this adds more complexity. For more information about Docker,
installation instructions, tutorials etc. look at
<a href="https://docs.docker.com">https://docs.docker.com</a> . In this arcticle we will focus only on the
steps relevant to B-Translator.
</p>


<div id="outline-container-1" class="outline-2">
<h3 id="sec-1">Getting images </h3>
<div class="outline-text-2" id="text-1">


<p>
First we have to get the image of the system. This is basically the
root filesystem of the system, very similar to the root filesystem
in the case of chroot.
</p>
<p>
We can do it in a single step, like this:
</p>


<pre class="example">docker import https://googledrive.com/host/0B7H_DCc2DjNGamstaDd5VjBydUk/docker-bcl-20140917.tar.gz btr_client
</pre>




<p>
Or we can download first the archive and then import it, like this:
</p>


<pre class="example">wget https://googledrive.com/host/0B7H_DCc2DjNGamstaDd5VjBydUk/docker-bcl-20140917.tar.gz
cat docker-bcl-20140917.tar.gz | docker import - btr_client_1
</pre>




<p>
The archive <code>docker-bcl-20140917.tar.gz</code> is a file generated by the
command <code>docker export</code>. The last argument of <code>docker import</code> is the
name that we assign to the imported image. If we run the command
<code>docker images</code> we should see this image on the list.
</p>
<p>
Another image available is <code>docker-btr-20140918.tar.gz</code>, the image
for B-Translator Server. For an updated list of the latest docker
images available look at:
<a href="https://googledrive.com/host/0B7H_DCc2DjNGamstaDd5VjBydUk/">https://googledrive.com/host/0B7H\_DCc2DjNGamstaDd5VjBydUk/</a>.
</p>
<p>
There is also another way for getting the images, the command
<code>docker pull</code>:
</p>


<pre class="example">docker search dashohoxha/btr
docker pull dashohoxha/btr_client:2.0
docker pull dashohoxha/btr_server:2.0
docker images
</pre>




<p>
These are the images that I have pushed to <a href="https://hub.docker.com">https://hub.docker.com</a>
with the command <code>docker push</code>.
</p>
<p>
Docker images can be deleted with the command <code>docker rmi</code>:
</p>


<pre class="example">docker rmi dashohoxha/btr_client:2.0 dashohoxha/btr_server:2.0
</pre>





</div>

</div>

<div id="outline-container-2" class="outline-2">
<h3 id="sec-2">Creating containers </h3>
<div class="outline-text-2" id="text-2">


<p>
We create containers by running docker on an image, with certain
parameters:
</p>


<pre class="example">docker run -d --name=bcl --hostname=example.org \
       -p 80:80 -p 443:443 btr_client \
       /usr/bin/supervisord -c /etc/supervisor/supervisord.conf --nodaemon
  OR
docker run -d --name=bcl --hostname=example.org \
       -p 80:80 -p 443:443 dashohoxha/btr_client:2.0
</pre>



<p>
If we now check the list of containers with <code>docker ps -a</code> we will
see there the container with name <b>bcl</b>. Also, the host ports <b>80</b>
and <b>443</b> (HTTP and HTTPS) are mapped to the same ports of the
container. A docker container can run a single process, and this
process in our case is <b>supervisord</b>, which starts and watches the
rest of services (httpd, mysql, cron, etc.).
</p>
<p>
Now that the docker container is running, we can stop and start it
like this:
</p>


<pre class="example">docker stop bcl
docker start bcl
docker restart bcl
</pre>




<p>
If needed, we can create other containers from the same image: 
</p>


<pre class="example">docker run -d --name=bcl1 -p 81:80 -p 444:443 dashohoxha/btr_client:2.0
docker run -d --name=bcl2 -p 82:80 -p 445:443 dashohoxha/btr_client:2.0</pre>




<p>
We can delete containers with <code>docker rm</code>, but we have to stop them
first:
</p>


<pre class="example">docker stop bcl1 bcl2
docker rm bcl1 bcl2
</pre>





</div>

</div>

<div id="outline-container-3" class="outline-2">
<h3 id="sec-3">Accessing the shell </h3>
<div class="outline-text-2" id="text-3">


<p>
In order to access the shell of a running Docker container, we have
to install <code>nsenter</code>:
</p>


<pre class="example">docker run -v /usr/local/bin:/target jpetazzo/nsenter
</pre>




<p>
Then we can access the shell of a container like this:
</p>


<pre class="example">docker-enter bcl
</pre>



<p>
This is the equivalent of <code>chroot /var/chroot/bcl/</code> in the case of
chroot installation.
</p>
<p>
From this shell we can check configuration files, logs, etc.
</p>
<p>
See also this article:
<a href="http://blog.docker.com/2014/06/why-you-dont-need-to-run-sshd-in-docker/">http://blog.docker.com/2014/06/why-you-dont-need-to-run-sshd-in-docker/</a>
</p>

</div>

</div>

<div id="outline-container-4" class="outline-2">
<h3 id="sec-4">Configuration of B-Translator </h3>
<div class="outline-text-2" id="text-4">


<p>
The image that we have used to create and start the container has a
standard configuration, with default domains, passwords, etc. We need
to customize these settings.
</p>
<p>
First we get to the shell of the container:
</p>


<pre class="example">docker-enter bcl
</pre>




<p>
Then we make a clone of the application code on <code>/usr/local/src/</code>:
</p>


<pre class="example">cd /usr/local/src/
git clone https://github.com/B-Translator/btr_client
</pre>




<p>
Finally we call the script <code>install/config.sh</code> (but we
remove first <code>bcl_dev</code> because the script will recreate
it):
</p>


<pre class="example">cd btr_client/
dev/clone_rm.sh bcl_dev
install/config.sh
</pre>





</div>

</div>

<div id="outline-container-5" class="outline-2">
<h3 id="sec-5">Starting a sshd server inside the container </h3>
<div class="outline-text-2" id="text-5">


<p>
We want to start a sshd server on port 2201 inside the container,
but when we created the container with <code>docker run</code> we did not think
about forwarding this port. We have to destroy this container and
create a new one, with an addition <code>-p</code> option for the
port 2201. But first we should use the command <code>docker commit</code> to
save to a new image any configurations and data that we already have
in this container.
</p>


<pre class="example">docker stop bcl
docker commit bcl btr_client_20140929
docker images
docker rm bcl
docker rmi btr_client
docker run -d --name=bcl --hostname=example.org \
           -p 80:80 -p 443:443 -p 2201:2201 btr_client_20140929
</pre>




<p>
Now we can enter the container and start the sshd server:
</p>


<pre class="example">docker-enter bcl
cd /usr/local/src/btr_client/
dev/install-sshd.sh 2201
</pre>



</div>
</div>
</div>
